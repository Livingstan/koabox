const parser = require('co-body')
const formidable = require('formidable')

module.exports = parser

// 定义from别名为urlencoded
parser.urlencoded = parser.form

parser.multipart = (ctx, opts = {
  encoding: 'utf-8'
}) => {
  return new Promise((resolve, reject) => {
    const form = new formidable.IncomingForm()

    // 设置编码
    form.encoding = opts.encoding

    // 存放字段
    const fields = {}
    // 存放文件
    const files = {}

    form.on('field', function (field, value) {
      if (fields[field]) {
        if (Array.isArray(fields[field])) {
          fields[field].push(value)
        } else {
          fields[field] = [fields[field], value]
        }
      } else {
        fields[field] = value
      }
    }).on('file', function (field, file) {
      if (files[field]) {
        if (Array.isArray(files[field])) {
          files[field].push(file)
        } else {
          files[field] = [files[field], file]
        }
      } else {
        files[field] = file
      }
    }).on('end', function () {
      return resolve({
        fields,
        files
      })
    }).on('error', function (err) {
      return reject(err)
    })

    // 执行解析
    form.parse(ctx.req)
  })
}
